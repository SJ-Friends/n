<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>엑셀 자동 로딩 지도</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif; }
    header { padding: 14px 16px; background:#fafafa; border-bottom:1px solid #eee; }
    h2 { margin: 0 0 8px; }
    .controls { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .controls > * { margin: 4px 0; }
    #map { width: 100%; height: 62vh; }
    .wrap { max-width: 1100px; margin: 14px auto; padding: 0 12px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 24px; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border:1px solid #e6e6e6; padding:8px; text-align:center; }
    th { background:#f3f4f6; }
    .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:12px; }
    .ok { background:#e6f7e6; color:#1a7f37; }
    .fail { background:#ffefef; color:#c1121f; }
    .hint { font-size:12px; color:#666; }
    .link { color:#0b70d0; text-decoration:underline; font-size:12px; }
    .progress { font-size:13px; color:#333; }
    .btn { padding:8px 12px; border:1px solid #ddd; background:#fff; border-radius:8px; cursor:pointer; }
    .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
  </style>
  <!-- Kakao Maps SDK -->
  <script type="text/javascript"
    src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a49fe18b80104f2300aeaadfc1cd9924&libraries=services"></script>
  <!-- SheetJS for reading Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <h2>엑셀/CSV 자동 로딩 → 지도 핀 표시</h2>
      <div class="controls">
        <button class="btn" id="btnReload">다시 불러오기</button>
        <button class="btn" id="btnClear">지도/목록 초기화</button>
        <button class="btn" id="btnFailCsv" disabled>실패목록 CSV 다운로드</button>
        <label class="hint">지오코딩 간격(ms):
          <input type="number" id="delayInput" value="300" style="width:80px;" />
        </label>
        <span class="progress" id="progressText">대기 중…</span>
      </div>
      <div class="hint">
        기본 파일: <code>./name_addresses.xlsx</code> → 실패 시 <code>./name_addresses.csv</code><br/>
        또는 URL 파라미터 사용: <code>?src=/경로/파일.xlsx</code> 또는 <code>?src=https://.../파일.csv</code>
      </div>
    </div>
  </header>

  <div id="map"></div>

  <div class="wrap grid">
    <section>
      <h3>✅ 성공 목록</h3>
      <table>
        <thead>
          <tr><th>#</th><th>이름</th><th>주소</th><th>상태</th><th>네이버 지도</th></tr>
        </thead>
        <tbody id="successTbody"></tbody>
      </table>
    </section>

    <section>
      <h3>❗ 실패 목록</h3>
      <table>
        <thead>
          <tr><th>#</th><th>이름</th><th>주소</th><th>사유</th><th>네이버 검색</th></tr>
        </thead>
        <tbody id="failTbody"></tbody>
      </table>
    </section>
  </div>

  <script>
    // ===== Kakao map init =====
    let map, geocoder, markers = [], openInfoWindow = null, bounds;
    function initMap() {
      map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(35.1796, 129.0756), // 부산 시청 근처 기본값
        level: 6
      });
      geocoder = new kakao.maps.services.Geocoder();
      bounds = new kakao.maps.LatLngBounds();
    }
    initMap();

    // ===== UI refs =====
    const progressText = document.getElementById('progressText');
    const successTbody = document.getElementById('successTbody');
    const failTbody = document.getElementById('failTbody');
    const btnClear = document.getElementById('btnClear');
    const btnFailCsv = document.getElementById('btnFailCsv');
    const btnReload = document.getElementById('btnReload');
    const delayInput = document.getElementById('delayInput');

    // ===== State =====
    let parsedRows = [];   // { name, address }
    let failRows = [];     // { 이름, 주소, 사유 }

    // ===== Helpers =====
    function setProgress(msg) { progressText.textContent = msg; }
    function sleep(ms){ return new Promise(res => setTimeout(res, ms)); }

    function clearMapAndTables() {
      if (markers.length) markers.forEach(m => m.setMap(null));
      markers = [];
      successTbody.innerHTML = '';
      failTbody.innerHTML = '';
      failRows = [];
      bounds = new kakao.maps.LatLngBounds();
      setProgress('초기화 완료');
      btnFailCsv.disabled = true;
    }
    btnClear.addEventListener('click', clearMapAndTables);

    // ===== Table rows & markers =====
    function addSuccessRow(idx, name, address, coords) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${name}</td>
        <td>${address}</td>
        <td><span class="badge ok">지오코딩 성공</span></td>
        <td><a class="link" target="_blank"
               href="https://map.naver.com/v5/search/${encodeURIComponent(address)}">네이버지도</a></td>`;
      successTbody.appendChild(tr);

      const marker = new kakao.maps.Marker({ map, position: coords, title: `${name}` });
      markers.push(marker);

      const infoWindow = new kakao.maps.InfoWindow({
        content: `
          <div style="padding:6px 8px;font-size:13px;line-height:1.4;">
            <b>${name}</b><br>${address}
          </div>`
      });
      kakao.maps.event.addListener(marker, 'click', () => {
        if (openInfoWindow) openInfoWindow.close();
        infoWindow.open(map, marker);
        openInfoWindow = infoWindow;
      });

      bounds.extend(coords);
      map.setBounds(bounds);
    }

    function addFailRow(idx, name, address, reason) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${idx+1}</td>
        <td>${name}</td>
        <td>${address}</td>
        <td><span class="badge fail">${reason || '실패'}</span></td>
        <td><a class="link" target="_blank"
               href="https://map.naver.com/v5/search/${encodeURIComponent(address)}">네이버 검색</a></td>`;
      failTbody.appendChild(tr);
      failRows.push({ 이름: name, 주소: address, 사유: reason || '지오코딩 실패' });
      btnFailCsv.disabled = failRows.length === 0;
    }

    // ===== CSV export for failed rows =====
    btnFailCsv.addEventListener('click', () => {
      if (!failRows.length) return;
      const header = '이름,주소,사유\n';
      const lines = failRows.map(r =>
        [r.이름, r.주소, r.사유].map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')
      ).join('\n');
      const blob = new Blob([header + lines], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'geocode_failed.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ===== Header normalization =====
    function normalizeHeader(h){
      if (!h) return '';
      return String(h).trim().replace(/\s+/g,'').toLowerCase();
    }
    function pickColumns(headers){
      let nameIdx = -1, addrIdx = -1;
      headers.forEach((h, i) => {
        const n = normalizeHeader(h);
        if (['이름','name'].includes(n)) nameIdx = i;
        if (['실제거주지주소','주소','address','actualaddress','residentialaddress'].includes(n)) addrIdx = i;
      });
      return { nameIdx, addrIdx };
    }

    // ===== File loading (auto via fetch) =====
    async function fetchArrayBuffer(url){
      const res = await fetch(url, { mode: 'cors' }); // same-origin이면 cors 옵션 무시됨
      if (!res.ok) throw new Error(`HTTP ${res.status} - ${url}`);
      return await res.arrayBuffer();
    }

    async function loadFromXlsx(url){
      const ab = await fetchArrayBuffer(url);
      const wb = XLSX.read(ab, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows:false });
      if (!rows.length) throw new Error('빈 시트입니다.');
      const headers = rows[0];
      const { nameIdx, addrIdx } = pickColumns(headers);
      if (nameIdx < 0 || addrIdx < 0) throw new Error('엑셀 헤더(이름/주소)를 찾지 못했습니다.');
      return rows.slice(1).map(r => ({ name: r[nameIdx], address: r[addrIdx] }))
                 .filter(r => r.name && r.address);
    }

    async function loadFromCsv(url){
      const ab = await fetchArrayBuffer(url);
      const text = new TextDecoder('utf-8').decode(new Uint8Array(ab));
      const lines = text.split(/\r?\n/).filter(Boolean);
      const headers = lines[0].split(',').map(h => h.replace(/(^"|"$)/g,''));
      const { nameIdx, addrIdx } = pickColumns(headers);
      if (nameIdx < 0 || addrIdx < 0) throw new Error('CSV 헤더(이름/주소)를 찾지 못했습니다.');
      return lines.slice(1).map(line => {
        const cols = line.split(',');
        return { name: cols[nameIdx]?.replace(/(^"|"$)/g,''), address: cols[addrIdx]?.replace(/(^"|"$)/g,'') };
      }).filter(r => r.name && r.address);
    }

    async function autoLoad() {
      try {
        setProgress('자동 로딩: 소스 결정 중…');
        const params = new URLSearchParams(location.search);
        const src = params.get('src'); // 사용자가 ?src= 로 지정할 수 있음

        if (src) {
          setProgress(`자동 로딩: ${src}`);
          parsedRows = src.toLowerCase().endsWith('.csv')
            ? await loadFromCsv(src)
            : await loadFromXlsx(src);
        } else {
          // 기본 경로 시도: xlsx → 실패 시 csv
          const xlsxUrl = './name_addresses.xlsx';
          const csvUrl = './name_addresses.csv';
          try {
            setProgress('자동 로딩: name_addresses.xlsx 시도…');
            parsedRows = await loadFromXlsx(xlsxUrl);
          } catch (e1) {
            console.warn('xlsx 로딩 실패, csv 시도:', e1);
            setProgress('자동 로딩: name_addresses.csv 시도…');
            parsedRows = await loadFromCsv(csvUrl);
          }
        }

        setProgress(`총 ${parsedRows.length}건 로드됨. 지오코딩 시작…`);
        await geocodeAll(parsedRows);
      } catch (err) {
        console.error(err);
        setProgress('자동 로딩 실패: ' + err.message);
      }
    }

    // ===== Geocode all =====
    async function geocodeAll(rows){
      clearMapAndTables();
      const delay = Math.max(0, Number(delayInput.value) || 300);
      let successCount = 0, failCount = 0;

      for (let i=0; i<rows.length; i++){
        const { name, address } = rows[i];
        setProgress(`지오코딩 ${i+1}/${rows.length}… (성공 ${successCount} / 실패 ${failCount})`);
        await new Promise(res => {
          geocoder.addressSearch(address, (result, status) => {
            if (status === kakao.maps.services.Status.OK && result?.length){
              const { x, y } = result[0];
              const coords = new kakao.maps.LatLng(y, x);
              addSuccessRow(i, name, address, coords);
              successCount++;
            } else {
              addFailRow(i, name, address, status || 'NOT_FOUND');
              failCount++;
            }
            res();
          });
        });
        if (delay) await sleep(delay);
      }
      setProgress(`완료! 총 ${rows.length}건 (성공 ${successCount} / 실패 ${failCount})`);
    }

    // ===== Buttons =====
    btnReload.addEventListener('click', autoLoad);

    // ===== Auto run on load =====
    window.addEventListener('DOMContentLoaded', autoLoad);
  </script>
</body>
</html>
